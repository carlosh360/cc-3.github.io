<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="../stylesheets/w3.css">
        <link rel="stylesheet" href="../stylesheets/w3-theme-black.css">
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
        <link rel="icon" href="../images/favicon.png" type="image/x-icon">
        <title>CC3 LAB 6</title>
        <style>
            header {
                background-image: url("../images/header.jpg");
                color: white;
                width:100%;
                min-height:400px;
                max-height:700px;
            }
            .w3-topnav a:first-child:hover{color: #009688;border-bottom: 3px solid transparent;}
        </style>
    </head>
    <body class="w3-light-grey">
        <nav class="w3-topnav w3-center w3-theme w3-card-4 w3-top">
              <a href="../index.html" title="HOME"><i class="fa fa-home w3-large"></i></a>
        </nav>
        <header id="header" class="w3-container w3-card-4 w3-padding-32">
            <div class="w3-center w3-padding-32">
                <div class="w3-center">
                    <h1 class="w3-jumbo">CC3 Estructura de Máquinas</h1>
                    <h1 class="w3-jumbo w3-animate-bottom">Laboratorio 6</h1>
                    <h4 class="w3-xxlarge">Cache Blocking</h4>
                </div>
            </div>
        </header>
        <div class="w3-container w3-margin-16">
            <h1 id="notas" class="w3-card-24 w3-theme w3-round-large w3-padding-left w3-card-4">Objetivos</h1>
            <div class="w3-card-24 w3-white w3-padding-8 w3-round-large">
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    <ul>
                        <li class="w3-large">Aprender una técnica de optimización.</li>
                        <li class="w3-large">Conocer como se manejan los datos internamente.</li>
                    </ul>
                </p>
            </div>
            <h1 id="notas" class="w3-card-24 w3-theme w3-round-large w3-padding-left w3-card-4">Setup</h1>
            <div class="w3-card-24 w3-white w3-padding-8 w3-round-large">
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    Descarguen los archivos necesarios para este laboratorio en el siguiente <a href="#" target="_blank"><span class="w3-btn w3-red w3-round w3-medium">link</link></a>
                </p>
            </div>
            <h1 id="notas" class="w3-card-24 w3-theme w3-round-large w3-padding-left w3-card-4">Un poco de Información</h1>
            <div class="w3-card-24 w3-white w3-padding-8 w3-round-large">
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    <strong>Multiplicación de Matrices</strong><br><br>
                    Si se recuerdan, las matrices son estructuras de 2 dimensiones, donde uno tiene acceso a cada elemento vía 2 índices. Para multiplicar dos matrices, se puede utilizar simplemente 3 ciclos anidados, asumiendo que las matrices A, B y C son cuadradas (nxn) y están guardadas en un arreglo de una dimensión:
                </p>
<pre class="w3-code w3-light-grey notransalte">
    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> n<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> j <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> j <span style='color:#808030; '>&lt;</span> n<span style='color:#800080; '>;</span> j<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
            <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>int</span> k <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> k <span style='color:#808030; '>&lt;</span> n<span style='color:#800080; '>;</span> k<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span>
                C<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span>j<span style='color:#808030; '>*</span>n<span style='color:#808030; '>]</span> <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> A<span style='color:#808030; '>[</span>i<span style='color:#808030; '>+</span>k<span style='color:#808030; '>*</span>n<span style='color:#808030; '>]</span> <span style='color:#808030; '>*</span> B<span style='color:#808030; '>[</span>k<span style='color:#808030; '>+</span>j<span style='color:#808030; '>*</span>n<span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
</pre>
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    La multiplicación de matrices son el core de muchos algoritmos de álgebra, y una eficiente multiplicación de matrices es crucial para muchas aplicaciones.
                    <br><br>
                    En el código de arriba, noten que los ciclos están ordenados por i, j, k. Si examinamos el ciclo interno (k), vemos que este se mueve a través de B con 1 paso, a través de A con n pasos y a través de C con 0 pasos. Para calcular la multiplicación de matrices correctamente, el orden de los ciclos no importa. Sin embargo, el orden en el que eligen acceder a los elementos de las matrices puede tener un mayor impacto en la performance del  programa. El cache funciona mejor (hay mas cache hit, y menos cache misses) cuando se accede a la memoria tomando en cuenta la localidad temporal y espacial. Optimizar el acceso a memoria es esencial para obtener una buena performance en la jerarquía de memoria.
                    <br><br>
                    <strong>Transponer Matrices</strong>
                    <br><br>
                    Algunas veces, se necesita intercambiar en una matriz filas por columnas. A esto se le llama "transponer" y una implementación eficiente puede ser bien útil, al utilizar operaciones de álgebra lineal más complicadas. La transpuesta de una matriz A se denota como A<sup>T</sup>.
                </p><br>
                <div class="w3-image w3-center">
                    <img class="w3-center" src="../images/matTnorm.png" alt="MT" />
                </div>
                <p class="w3-text-grey w3-justify w3-center w3-medium w3-margin-16">Image Credit: UC Berkeley</p>
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    <strong>Cache Blocking</strong>
                    <br><br>
                    En el código de arriba de multiplicación de matrices, noten que para calcular un valor de C necesitamos atravesar las matrices A y B completamente. Nosotros estamos constantemente accediendo a valores nuevos de la memoria y reusando muy poco los datos que están en el cache. Podemos mejorar el reuso de esos datos en cache, implementando una técnica llamada cache blocking. Más formalmente, el cache blocking es una técnica que trata de reducir el “cache miss rate” mejorando la localidad temporal y/o espacial de los accesos a memoria. En el caso de la transpuesta de una matriz nosotros consideramos un bloque pequeño en cada tiempo.
                </p><br>
                <div class="w3-image w3-center">
                    <img class="w3-center" src="../images/matTblock.png" alt="MT" />
                </div>
                <p class="w3-text-grey w3-justify w3-center w3-medium w3-margin-16">Image Credit: UC Berkeley</p>
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    En la imagen de arriba, nosotros transponemos cada bloque Aij de la matriz A a su posición final en la matriz de salida, un bloque a la vez. Con este esquema, nosotros podemos reducir el trabajo de llenar el cache durante el procesamiento de cualquier bloque. Esto (si está implementado correctamente) va resultar en un performance bastante significativo. En este lab van a implementar la técnica del cache blocking para calcular la transpuesta de una matriz y verificar su performance.
                </p>
            </div>
            <h1 id="notas" class="w3-card-24 w3-theme w3-round-large w3-padding-left w3-card-4">Ejercicio 1: Multiplicación de Matrices</h1>
            <div class="w3-card-24 w3-white w3-padding-8 w3-round-large">
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    Échenle un vistazo a matrixMultiply.c. Van a notar que el archivo contiene múltiples implementaciones de una multiplicación de matrices con 3 ciclos anidados.
                    <br><br>
                    Compilen y corran su código con el siguiente comando:
                </p>
<pre class="w3-code w3-light-grey notranslate">
    <span class="w3-text-teal">$</span> make ex1
</pre>
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    Noten que el comando de compilación en el Makefile usa la bandera “-O3”. Es importante que aquí utilicemos la bandera “-O3” para que el compilador haga optimizaciones. El Makefile va a correr matrixMultiply dos veces. Copien los resultados en algún lugar para que ustedes no tengan que correr el programa otra vez y utilícenlos para responder a las siguientes preguntas:
                    <ol>
                        <li class="w3-large">¿Por qué el perfomance de Gflops/s baja con valores de n grandes?</li>
                        <li class="w3-large">¿Qué orden de los ciclos tiene el mejor perfomance en las matrices de 1000x1000?</li>
                        <li class="w3-large">¿Qué orden tiene el peor performance?</li>
                        <li class="w3-large">¿Cómo la manera en que avanzamos en las matrices con respecto al ciclo interno afecta el performance?</li>
                    </ol>
                </p>
            </div>
            <h1 id="notas" class="w3-card-24 w3-theme w3-round-large w3-padding-left w3-card-4">Ejercicio 2: Transpuesta de una Matriz</h1>
            <div class="w3-card-24 w3-white w3-padding-8 w3-round-large">
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    Compilen y corran la implementación (no muy buena) de la transpuesta de una matriz en transpose.c
                </p>
<pre class="w3-code w3-light-grey notranslate">
    <span class="w3-text-teal">$</span> make ex2
</pre>
                <p class="w3-text w3-justify w3-large w3-margin-16">
                    Lo siguiente, completar los siguientes ejercicios.
                    <ol>
                        <li class="w3-large">Noten el tiempo requerido para realizar la transpuesta de una matriz de tamaño 2000x2000</li>
                        <li class="w3-large">Modifiquen la función llamada tranpose en transpose.c para implementar un nivel de cache blocking. Esto es, hacer un ciclo que tome pequeños bloques de una matriz, a ese pequeño bloque hacerle la transpuesta y guardarlo en la matriz de destino. Asegúrense de manejar los casos especiales de la transpuesta: ¿Qué pasa si tratamos de aplicarle la transpuesta a una matriz de 5x5 con un tamaño de bloque de 2?</li>
                        <li class="w3-large">Prueben tamaños de bloque de 2x2, 100x100, 200x200, 400x400 y 1000x1000. ¿Cuál tiene la mejor performance en una matriz de 2000x2000? ¿Cuál tiene el peor performance?</li>
                    </ol>
                </p>
            </div>
        </div>
        <footer class="w3-container w3-padding-32 w3-theme w3-center">
            <h2>CC3 - 2016</h2>
            <a class="w3-btn-floating w3-teal" href="https://slack.com/" title="SLACK"><i class="fa fa-slack"></i></a>
            <h4>Universidad Galileo</h4>
            <div style="position:relative;bottom:103px;z-index:1;" class="w3-tooltip w3-right">
                <a class="w3-btn w3-theme" href="#header"><span class="w3-xlarge">
                <i class="fa fa-chevron-circle-up"></i></span></a>
            </div>
        </footer>
    </body>
</html>
